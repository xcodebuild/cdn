import{u as O,v as R,a as F,k as L,l as V,d as D,r as h,M as v,w as N,n as l,j as e,L as M,U as A,I as r,V as p,T as y,s as j}from"./index-DRKdyhzb.js";import{c as P}from"./index-BG_UZG-p.js";import{b as z,s as _,c as K,M as H,a as W,d as q}from"./MemoView-Cm1UAYRp.js";import{a as G,M as J,b as Q}from"./index-2UGuc62r.js";import{M as X}from"./MobileHeader-DhNMB_G6.js";import{V as Y,c as Z}from"./VisibilityIcon-ijzoLo4J.js";import{S as ee,O as se}from"./Select-2jlx2KYh.js";import"./CommonDialog-aMGtbYQ-.js";import"./last-DXTTfs9a.js";import"./useLoading-Dble4Yjd.js";import"./Typography-B6lazjNl.js";import"./createSvgIcon-DiGfNeH6.js";import"./Checkbox-BFDDHFvA.js";import"./Link-bshFRLSU.js";import"./ResourceIcon-CVNzAEyj.js";import"./Divider-ByJybYhk.js";const je=()=>{const o=O(),b=R(),n=F(),c=L(),a=V(),C=D(),[i,k]=h.useState(),m=b.memoName,s=a.getMemoByName(m||""),[u,w]=h.useState(void 0),I=(s==null?void 0:s.relations.filter(t=>t.type===v.REFERENCE))||[],g=(s==null?void 0:s.relations.filter(t=>t.relatedMemoId===(s==null?void 0:s.id)&&t.type===v.COMMENT))||[],f=g.map(t=>a.getMemoById(t.memoId)).filter(t=>t),d=(s==null?void 0:s.creatorId)!==(c==null?void 0:c.id);if(h.useEffect(()=>{m?a.getOrFetchMemoByName(m).then(async t=>{const x=await C.getOrFetchUserByUsername(N(t.creator));k(x)}).catch(t=>{l.error(t.details),n("/403")}):n("/404")},[m]),h.useEffect(()=>{s&&(async()=>(s.parentId?a.getOrFetchMemoById(s.parentId).then(t=>{w(t)}):w(void 0),await Promise.all(g.map(t=>a.getOrFetchMemoById(t.memoId)))))()},[s]),!s)return null;const T=async t=>{await a.updateMemo({id:s.id,visibility:t},["visibility"])},E=()=>{q({memoId:s.id,cacheKey:`${s.id}-${s.updateTime}`})},S=()=>{P(`${window.location.origin}/m/${s.name}`),s.visibility!==p.PUBLIC?l.success(o("message.succeed-copy-link-not-public")):l.success(o("message.succeed-copy-link"))},B=async t=>{await a.getOrFetchMemoById(t),await a.getOrFetchMemoById(s.id,{skipCache:!0})},U=()=>{n("/archived"),l.success("Memo archived")},$=()=>{n("/"),l.success("Memo deleted")};return e.jsxs("section",{className:"@container w-full max-w-5xl min-h-full flex flex-col justify-start items-center sm:pt-3 md:pt-6 pb-8",children:[e.jsx(X,{}),e.jsxs("div",{className:"w-full px-4 sm:px-6",children:[e.jsxs("div",{className:"relative flex-grow w-full min-h-full flex flex-col justify-start items-start border dark:border-zinc-700 bg-white dark:bg-zinc-800 shadow hover:shadow-xl transition-all p-4 pb-3 rounded-lg",children:[e.jsx("div",{className:"mb-3",children:e.jsx(M,{to:`/u/${encodeURIComponent(N(s.creator))}`,unstable_viewTransition:!0,children:e.jsxs("span",{className:"w-full flex flex-row justify-start items-center",children:[e.jsx(A,{className:"!w-10 !h-10 mr-2",avatarUrl:i==null?void 0:i.avatarUrl}),e.jsxs("div",{className:"flex flex-col justify-start items-start gap-1",children:[e.jsx("span",{className:"text-lg leading-none text-gray-600 max-w-[8em] truncate dark:text-gray-400",children:i==null?void 0:i.nickname}),e.jsx("span",{className:"text-sm leading-none text-gray-400 select-none",children:G(s.displayTime)})]})]})})}),u&&e.jsx("div",{className:"w-auto mb-2",children:e.jsxs(M,{className:"px-3 py-1 border rounded-lg max-w-xs w-auto text-sm flex flex-row justify-start items-center flex-nowrap text-gray-600 dark:text-gray-400 dark:border-gray-500 hover:shadow hover:opacity-80",to:`/m/${u.name}`,unstable_viewTransition:!0,children:[e.jsx(r.ArrowUpLeftFromCircle,{className:"w-4 h-auto shrink-0 opacity-60 mr-2"}),e.jsx("span",{className:"truncate",children:u.content})]})}),e.jsx(J,{memoId:s.id,content:s.content,readonly:d},`${s.id}-${s.updateTime}`),e.jsx(Q,{resources:s.resources}),e.jsx(z,{memo:s,relations:I}),e.jsxs("div",{className:"w-full mt-3 select-none flex flex-row justify-between items-center gap-2",children:[e.jsx("div",{className:"flex flex-row justify-start items-center",children:!d&&e.jsx(ee,{className:"w-auto text-sm",variant:"plain",value:s.visibility,startDecorator:e.jsx(Y,{visibility:s.visibility}),onChange:(t,x)=>{x&&T(x)},children:[p.PRIVATE,p.PROTECTED,p.PUBLIC].map(t=>e.jsx(se,{value:t,className:"whitespace-nowrap",children:o(`memo.visibility.${Z(t).toLowerCase()}`)},t))})}),e.jsxs("div",{className:"flex flex-row sm:justify-end items-center",children:[!d&&e.jsx(y,{title:"Edit",placement:"top",children:e.jsx(j,{size:"sm",onClick:E,children:e.jsx(r.Edit3,{className:"w-4 h-auto text-gray-600 dark:text-gray-400"})})}),e.jsx(y,{title:"Copy link",placement:"top",children:e.jsx(j,{size:"sm",onClick:S,children:e.jsx(r.Link,{className:"w-4 h-auto text-gray-600 dark:text-gray-400"})})}),e.jsx(y,{title:"Share",placement:"top",children:e.jsx(j,{size:"sm",onClick:()=>_(s.id),children:e.jsx(r.Share,{className:"w-4 h-auto text-gray-600 dark:text-gray-400"})})}),!d&&e.jsx(K,{className:"ml-1",memo:s,hiddenActions:["pin","edit","share"],onArchived:U,onDeleted:$})]})]})]}),e.jsxs("div",{className:"pt-8 pb-16 w-full",children:[e.jsx("h2",{id:"comments",className:"sr-only",children:"Comments"}),e.jsxs("div",{className:"relative mx-auto flex-grow w-full min-h-full flex flex-col justify-start items-start gap-y-1",children:[f.length===0?e.jsxs("div",{className:"w-full flex flex-col justify-center items-center py-6 mb-2",children:[e.jsx(r.MessageCircle,{strokeWidth:1,className:"w-8 h-auto text-gray-400"}),e.jsx("p",{className:"text-gray-400 italic text-sm",children:o("memo.comment.no-comment")})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"w-full flex flex-row justify-start items-center pl-3 mb-3",children:[e.jsx(r.MessageCircle,{className:"w-5 h-auto text-gray-400 mr-1"}),e.jsx("span",{className:"text-gray-400 text-sm",children:o("memo.comment.self")}),e.jsxs("span",{className:"text-gray-400 text-sm ml-0.5",children:["(",f.length,")"]})]}),f.map(t=>e.jsx(H,{memo:t,showCreator:!0},`${s.id}-${s.displayTime}`))]}),c&&e.jsx(W,{cacheKey:`comment-editor-${s.id}`,parentMemoId:s.id,onConfirm:B},s.id)]})]})]})]})};export{je as default};
